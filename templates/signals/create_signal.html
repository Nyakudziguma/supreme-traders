<!-- templates/signals/create_signal.html -->
{% extends 'base.html' %}

{% block title %}Create Signal - Henry Patson{% endblock %}

{% block page_title %}Create Trading Signal{% endblock %}
{% block page_subtitle %}Send professional trading signals to subscribers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Form Container -->
    <div class="bg-white rounded-xl border border-amber-200 shadow-sm">
        <div class="px-6 py-4 border-b border-amber-200 bg-gradient-to-r from-amber-50 to-white">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-plus-circle text-amber-600 mr-2"></i>
                New Trading Signal
            </h3>
        </div>
        
        <form method="post" class="p-6" id="signalForm">
            {% csrf_token %}
            
            {% if messages %}
                {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 border-red-200 text-red-800{% else %}bg-green-100 border-green-200 text-green-800{% endif %} border">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            Basic Information
                        </h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Signal Title *
                            </label>
                            <input type="text" 
                                   name="title" 
                                   required
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="e.g., V100 Index Buy Signal">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Signal Type *
                                </label>
                                <select name="signal_type" 
                                        required
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="buy">BUY Signal</option>
                                    <option value="sell">SELL Signal</option>
                                    <option value="alert">Market Alert</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Market Type *
                                </label>
                                <select name="market_type" 
                                        required
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="indices">Indices</option>
                                    <option value="forex">Forex</option>
                                    <option value="crypto">Cryptocurrency</option>
                                    <option value="commodities">Commodities</option>
                                    <option value="stocks">Stocks</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Asset Name *
                                </label>
                                <input type="text" 
                                       name="asset_name" 
                                       required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="e.g., Volatility 100 Index">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Asset Pair/Symbol *
                                </label>
                                <input type="text" 
                                       name="asset_pair" 
                                       required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="e.g., V100, EUR/USD">
                            </div>
                        </div>
                    </div>

                    <!-- Trade Parameters -->
                    <div class="space-y-4">
                        <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-chart-line text-green-600 mr-2"></i>
                            Trade Parameters
                        </h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Entry Type
                                </label>
                                <select name="entry_type" 
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="market">Market Execution</option>
                                    <option value="limit">Limit Order</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Entry Price
                                </label>
                                <input type="number" 
                                       step="0.000001"
                                       name="entry_price"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Optional">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Stop Loss *
                                </label>
                                <input type="number" 
                                       step="0.000001"
                                       name="stop_loss" 
                                       required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="e.g., 660.17">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Take Profit *
                                </label>
                                <input type="number" 
                                       step="0.000001"
                                       name="take_profit" 
                                       required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="e.g., 760.60">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Lot Size
                            </label>
                            <input type="number" 
                                   step="0.01"
                                   name="lot_size" 
                                   value="1.00"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Signal Details -->
                    <div class="space-y-4">
                        <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-cog text-gray-600 mr-2"></i>
                            Signal Details
                        </h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Volatility Level
                                </label>
                                <select name="volatility" 
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Confidence Level (%)
                                </label>
                                <input type="number" 
                                       min="1" 
                                       max="100"
                                       name="confidence" 
                                       value="75"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Technical Analysis
                            </label>
                            <textarea name="analysis" 
                                      rows="3"
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                      placeholder="Technical analysis and reasoning..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Risk Note
                            </label>
                            <textarea name="risk_note" 
                                      rows="2"
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                      placeholder="Ensure proper risk management and only take trades that align with your plan."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Additional Notes
                            </label>
                            <textarea name="additional_notes" 
                                      rows="2"
                                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                      placeholder="Any additional instructions..."></textarea>
                        </div>
                    </div>

                    <!-- WhatsApp Preview -->
                    <div class="space-y-4">
                        <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                            <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                            WhatsApp Message Preview
                        </h4>
                        
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <pre id="whatsappPreview" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            This preview shows how the signal will appear in WhatsApp messages
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden WhatsApp Template -->
            <textarea name="whatsapp_template" id="whatsappTemplate" class="hidden">ðŸ“ˆ Supreme Traders â€“ {{asset_name}} {{signal_type}} Signal

Direction:  {{signal_type}} â€“ {{asset_name}}
Entry: {{entry_type}}
{% if entry_price %}Entry Price:  {{entry_price}}{% endif %}
Stop Loss:  {{stop_loss}}
Take Profit:  {{take_profit}}
Lot Size:  {{lot_size}}
Number of Positions:  Optional â€” based on your risk appetite

Note: {{risk_note}}
{% if additional_notes %}{{additional_notes}}{% endif %}</textarea>

            <!-- Form Actions -->
            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end space-x-3">
                <a href="{% url 'signals:dashboard' %}" 
                   class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition-colors">
                    Cancel
                </a>
                <button type="submit" 
                        name="save_as_draft"
                        class="px-5 py-2.5 border border-amber-300 text-amber-700 hover:bg-amber-50 font-medium rounded-lg transition-colors">
                    Save as Draft
                </button>
                <button type="submit" 
                        name="save_and_send"
                        class="btn-gold px-5 py-2.5 rounded-lg font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Create & Send
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Update WhatsApp preview in real-time
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('signalForm');
    const preview = document.getElementById('whatsappPreview');
    const template = document.getElementById('whatsappTemplate').value;
    
    function updatePreview() {
        const formData = new FormData(form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Basic template replacement
        let message = template
            .replace(/{{asset_name}}/g, data.asset_name || '{{asset_name}}')
            .replace(/{{signal_type}}/g, (data.signal_type === 'buy' ? 'BUY' : data.signal_type === 'sell' ? 'SELL' : 'ALERT'))
            .replace(/{{entry_type}}/g, data.entry_type === 'market' ? 'Market Execution' : 'Limit Order')
            .replace(/{{entry_price}}/g, data.entry_price || '')
            .replace(/{{stop_loss}}/g, data.stop_loss || '{{stop_loss}}')
            .replace(/{{take_profit}}/g, data.take_profit || '{{take_profit}}')
            .replace(/{{lot_size}}/g, data.lot_size || '1.00')
            .replace(/{{risk_note}}/g, data.risk_note || 'Ensure proper risk management and only take trades that align with your plan.')
            .replace(/{{additional_notes}}/g, data.additional_notes || '');
        
        preview.textContent = message;
    }
    
    // Update preview on any input change
    form.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('input', updatePreview);
        element.addEventListener('change', updatePreview);
    });
    
    // Initial preview
    updatePreview();
    
    // Form validation
    form.addEventListener('submit', function(event) {
        const stopLoss = form.querySelector('input[name="stop_loss"]').value;
        const takeProfit = form.querySelector('input[name="take_profit"]').value;
        
        if (!stopLoss || !takeProfit) {
            alert('Please enter both Stop Loss and Take Profit values.');
            event.preventDefault();
            return;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]:not([name="save_as_draft"])');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
        }
    });
});
</script>

<style>
input, select, textarea {
    transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus {
    border-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

#whatsappPreview {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    line-height: 1.5;
}
</style>

{% endblock %}